<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Print Service</title>

  <!-- PDF.js for page counting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>

  <!-- Razorpay checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(-45deg, #43cea2, #185a9d, #00c9ff, #92fe9d);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    form {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
      color: #2e7d32;
      font-size: 13px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 12px;
      border: 1px solid #a5d6a7;
      border-radius: 6px;
      outline: none;
      font-size: 13px;
      background: #f9f9f9;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #2e7d32;
      box-shadow: 0 0 6px rgba(46,125,50,0.6);
    }
    button {
      width: 100%;
      background: linear-gradient(90deg, #43cea2, #2e7d32);
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    button:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(46,125,50,0.4); }
    button:active { transform: scale(0.95); }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body>
  <form id="orderForm">
    <label>Name:</label>
    <input type="text" id="name" required>

    <label>Phone:</label>
    <input type="text" id="phone" required>

    <label>Upload PDFs:</label>
    <input type="file" id="files" accept="application/pdf" multiple required>

    <label>Pages:</label>
    <input type="number" id="pages" readonly>

    <label>Print Type:</label>
    <select id="printType">
      <option value="bw">Black & White</option>
      <option value="color">Color</option>
    </select>

    <label>Binding Type:</label>
    <select id="bindingType">
      <option value="none">None</option>
      <option value="spiral">Spiral</option>
    </select>

    <label>Amount (INR):</label>
    <input type="text" id="amount" readonly>

    <button type="button" id="payBtn">Pay & Order</button>
  </form>

  <script>
    (function() {
      const BASE_URL = "https://student-style.onrender.com";
      let currentPrices = { bw: 1.5, color: 10, spiral: 20 };

      document.addEventListener("DOMContentLoaded", () => {
        const nameEl = document.getElementById("name");
        const phoneEl = document.getElementById("phone");
        const filesEl = document.getElementById("files");
        const pagesEl = document.getElementById("pages");
        const printEl = document.getElementById("printType");
        const bindEl = document.getElementById("bindingType");
        const amountEl = document.getElementById("amount");
        const payBtn = document.getElementById("payBtn");

        // Load prices from backend
        fetch(`${BASE_URL}/admin/prices`)
          .then(r => r.ok ? r.json() : Promise.reject(new Error("Prices fetch failed")))
          .then(p => { currentPrices = p; })
          .catch(() => {});

        filesEl.addEventListener("change", handleFilesChange);
        printEl.addEventListener("change", calculateAmount);
        bindEl.addEventListener("change", calculateAmount);
        payBtn.addEventListener("click", pay);

        function validateName(name) { return /^[A-Za-z\s]{3,}$/.test(name.trim()); }
        function validatePhone(phone) { return /^\d{10}$/.test(phone.trim()); }

        async function handleFilesChange(e) {
          const files = [...e.target.files];
          let totalPages = 0;

          for (const file of files) {
            if (file.type !== "application/pdf") {
              alert("Only PDF files are allowed.");
              e.target.value = "";
              return;
            }
            const reader = new FileReader();
            const pdfData = await new Promise(resolve => {
              reader.onload = () => resolve(new Uint8Array(reader.result));
              reader.readAsArrayBuffer(file);
            });
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
            totalPages += pdf.numPages;
          }

          pagesEl.value = totalPages;
          calculateAmount();
        }

        function calculateAmount() {
          const pages = parseInt(pagesEl.value || "0", 10);
          const printType = printEl.value;
          const bindingType = bindEl.value;

          let amount = 0;
          if (printType === "bw") amount += pages * currentPrices.bw;
          if (printType === "color") amount += pages * currentPrices.color;
          if (bindingType === "spiral") amount += currentPrices.spiral;

          amountEl.value = amount.toFixed(2);
        }

        function pay() {
          if (!validateName(nameEl.value)) {
            alert("Invalid name.");
            return;
          }
          if (!validatePhone(phoneEl.value)) {
            alert("Invalid phone number.");
            return;
          }
          if (!filesEl.files.length) {
            alert("Please upload at least one PDF.");
            return;
          }

          const form = new FormData();
          [...filesEl.files].forEach(f => form.append("files", f));
          form.append("service", "print");
          form.append("name", nameEl.value.trim());
          form.append("phone", phoneEl.value.trim());
          form.append("printType", printEl.value);
          form.append("bindingType", bindEl.value);
          form.append("pages", pagesEl.value);
          form.append("amount", amountEl.value);

          fetch(`${BASE_URL}/order`, { method: "POST", body: form })
            .then(r => r.ok ? r.json() : Promise.reject(new Error("Order creation failed")))
            .then(d => {
              const rzp = new Razorpay({
                key: d.key,
                amount: d.amount * 100,
                currency: "INR",
                order_id: d.orderId,
                handler: function() {
                  alert("✅ Payment successful! Your order has been placed.");
                }
              });
              rzp.open();
            })
            .catch(err => {
              console.error("Order/Payment error:", err);
              alert("⚠️ Unable to process payment right now.");
            });
        }
      });
    })();
  </script>
</body>
</html>
